---
title: "STA 106 Final Project"
author: "Document Author"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: hpstr
    highlight: github
    toc: True
---

# Overall Analysis 
## Data Prep and Exploratory Data Analysis 
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(purrr)
library(magrittr)
library(dplyr)
library(ggplot2)
library(kableExtra)
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Inital Data Prep 
COVID19 = read.table("COVID19.txt", header = T, sep = "\t")
COVID19[652,c(5:7)] = 0

COVID19$AgeGroup %<>%  as.factor
COVID19$Sex %<>%  as.factor
COVID19$AgeGroup = factor(COVID19$AgeGroup,levels(COVID19$AgeGroup),1:7)
# 2 is female 1 is Male
COVID19$Sex = factor(COVID19$Sex,COVID19$Sex %>% levels,2:1) 
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
# Inital Histogram AgeGroup 1
factor_a_level_1_hist <- ggplot(data = COVID19 %>% filter(AgeGroup == 1),aes(x = COVIDProp))+ 
  geom_histogram()+xlab("Proportion of Total Deaths")+ylab("Count")+
  labs(title = "Proportion of Total Deaths Related to Covid19 Ages 0-17 years")
factor_a_level_1_hist

COVID19 = COVID19[-which(COVID19$AgeGroup == 1),]
COVID19$AgeGroup = factor(COVID19$AgeGroup,2:7,1:6)
COVID19$COVIDProp <- COVID19$COVIDProp %>% sqrt
#COVID19$COVIDProp <- 2 * asin(sqrt(COVID19$COVIDProp))
```




## Calculating Least Square Estimates

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Model Estimates and Residuals
model_estimates <- function(a,b,factorA,factorB,Y){

Yijbar = matrix(0,nrow = a,ncol = b)
for(i in 1:a)
{
  for(j in 1:b)
  {
    Yijbar[i,j] = mean(Y[factorA==i&factorB==j])
  }
}
u = mean(Y)
Yidotbar = apply(Yijbar,MARGIN = 1,mean)
Ydotjbar  = apply(Yijbar,MARGIN = 2,mean)
alpha = Yidotbar-u
beta = Ydotjbar-u
gamma = matrix(0,nrow = a,ncol = b)
for(i in 1:a)
{
  for(j in 1:b)
  {
    gamma[i,j] = Yijbar[i,j]-Yidotbar[i]-Ydotjbar[j]+u
  }
}

Yhat = rep(0,length(Y))
for(i in 1:a)
{
  for(j in 1:b)
  {
    Yhat[factorA==i&factorB==j] = Yijbar[i,j]
  }
}

e = Y-Yhat

return(list("Yijbar" = Yijbar,"Alpha" = alpha,"Beta" = beta,"Gamma" = gamma,"Yhat" = Yhat,"Residuals" = e,"Overall_Mean" = u))
}



Y = COVID19$COVIDProp
factorA = COVID19$AgeGroup
factorB = COVID19$Sex
a = factorA %>% levels %>% length 
b = factorB %>% levels %>% length 
n = 52

model_est_resid <- model_estimates(a,b,factorA,factorB,Y)

output_alpha <- data.frame("Alpha" = model_est_resid$Alpha)
output_overall_mean <- data.frame("Overall_Mean" = model_est_resid$Overall_Mean)
output_beta <- data.frame("Beta" = model_est_resid$Beta)
output_gamma <- data.frame("Gamma" = model_est_resid$Gamma)
output_lst_model_param <- list(output_overall_mean,output_alpha,output_beta,output_gamma)

output_lst_model_param%>%
   kable(caption = "Model Parameters") %>%
   kable_styling(full_width = TRUE,position = "center")



```



## Model Diagnostics



```{r echo=FALSE, message=FALSE, warning=FALSE}
# Residual Plot
residual_plot <- ggplot()+
  geom_point(data = COVID19,aes(x = model_est_resid$Yhat, y = model_est_resid$Residuals ,shape = AgeGroup ,color = Sex ))+
  xlab("Fitted Values")+ylab("Residuals")+scale_color_manual(values = c("lightblue","pink"),labels = c("Male","Female"))+
  scale_shape_manual(values = c(15,16,17,18,19,20),labels = c("18-29 years","30-49 years","50-64 years","65-74 years","75-84 years","85 years and over"))


response_values <- c(rep(COVID19$Sex %>% levels %>% extract(1),6),rep(COVID19$Sex %>% levels %>% extract(2),6)) %>% 
         map2(rep(COVID19$AgeGroup %>% levels,2),~COVID19 %>%
         filter(Sex == .x,AgeGroup == .y) %>% extract2("COVIDProp")) 

factor_means <- c(rep(COVID19$Sex %>% levels %>% extract(1),6),rep(COVID19$Sex %>% levels %>% extract(2),6)) %>% 
         map2(rep(COVID19$AgeGroup %>% levels,2),~COVID19 %>%
         filter(Sex == .x,AgeGroup == .y) %>% extract2("COVIDProp") %>% mean) %>% unlist

fitted_values <- c(1:12) %>% map2(c(rep(52,12)),~rep(factor_means[.x],.y)) 

residuals <- response_values %>% map2(fitted_values,~.x - .y)


residual_plot <- residual_plot + map2(fitted_values,residuals,~geom_segment(
                                                           aes(x = .x %>% unique,y = .y %>% min,xend = .x %>% unique,
                                                               yend = .y %>% max),alpha = 0.25))
residual_plot
```



```{r echo=FALSE, message=FALSE, warning=FALSE}
# QQ Plot
e_standard <- model_est_resid$Residuals - (model_est_resid$Residuals %>% mean)
e_standard <- e_standard/model_est_resid$Residuals %>% sd

qq_plot <- ggplot(mapping = aes(sample = e_standard)) + geom_qq()+geom_qq_line(col = 2)+
  labs(title = "Normal Q-Q Plot")+xlab("Theoretical Quantiles")+
  ylab("Sample Quantiles")+theme_bw()+theme(panel.grid = element_blank())

qq_plot

```




```{r echo=FALSE, message=FALSE, warning=FALSE}
# Interaction Plot
COVID19 %<>% group_by(AgeGroup,Sex)

interaction_plot <- ggplot(data =COVID19,aes(AgeGroup,COVIDProp,color = Sex,group = Sex)) +
  stat_summary(fun = mean,geom = "point")+
  stat_summary(fun = mean,geom = "line")+
  ylab("Mean Proportion of Deaths")+
  xlab("Factor A: Age Group" )+
  labs(color = "Factor B: Sex")+
  scale_x_discrete(labels = c("18-29 years","30-49 years","50-64 years","65-74 years","75-84 years","85 years and over"))+
  scale_color_manual(labels = c("Male","Female"),values = c("#7AD7F0","#FF69B4"))

interaction_plot

COVID19 %<>% ungroup

```

## Formal Analysis of Main Factor and Interaction Effects

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Anova Table Function
Anova.Table <- function(a,b,n,u,e,Yhat,alpha,beta,gamma,Y,factorA,factorB){
SSA = n*b*sum(alpha^2)
SSB = n*a*sum(beta^2)
SSAB = n*sum(gamma^2)

SSE = sum((Y-Yhat)^2)
SSTotal = sum((Y-u)^2)
AnovaTable = matrix(0,nrow = 5,ncol = 3)
AnovaTable[1,1] = SSA
AnovaTable[1,2] = a-1
AnovaTable[1,3] = SSA/(a-1)
AnovaTable[2,1] = SSB
AnovaTable[2,2] = b-1
AnovaTable[2,3] = SSB/(b-1)
AnovaTable[3,1] = SSAB
AnovaTable[3,2] = (a-1)*(b-1)
AnovaTable[3,3] = SSAB/((a-1)*(b-1))
AnovaTable[4,1] = SSE
AnovaTable[4,2] = a*b*(n-1)
AnovaTable[4,3] = SSE/(a*b*(n-1))
AnovaTable[5,1] = SSTotal
AnovaTable[5,2] = n*a*b-1
AnovaTable[5,3] = NA
AnovaTable = as.data.frame(AnovaTable)
rownames(AnovaTable) = c('Factor A','Factor B','AB Interaction','Error','Total')
colnames(AnovaTable) = c('SS','df','MS')
AnovaTable$SS %<>% as.numeric
AnovaTable$MS %<>% as.numeric
AnovaTable$df %<>% as.numeric
return(AnovaTable)
}

AnovaTable <- Anova.Table(a,b,n,model_est_resid$Overall_Mean,model_est_resid$Residuals,
                          model_est_resid$Yhat,model_est_resid$Alpha,model_est_resid$Beta,
                          model_est_resid$Gamma,Y,factorA,factorB)
AnovaTable %>% 
   kable(caption = "Anova Table") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# F test for Interaction/Factor A/Factor B effects

F_Test_Effects <- function(anova_table,alpha){
  test_stat_interact <- anova_table["AB Interaction","MS"]/anova_table["Error","MS"]
  critical_value_interact <- qf(1-alpha,anova_table["AB Interaction","df"],anova_table["Error","df"])
  p_value_interact <- pf(test_stat_interact,anova_table["AB Interaction","df"],anova_table["Error","df"],lower.tail = FALSE)
  F_test_df_interact <- data.frame("F_Statistic" = test_stat_interact,"F_Critical_Value" = critical_value_interact,"P_Value" = p_value_interact)

  test_stat_a <- anova_table["Factor A","MS"]/anova_table["Error","MS"]
  critical_value_a <- qf(1-alpha,anova_table["Factor A","df"],anova_table["Error","df"])
  p_value_a <- pf(test_stat_a,anova_table["Factor A","df"],anova_table["Error","df"],lower.tail = FALSE)
  F_test_df_a <- data.frame("F_Statistic" = test_stat_a,"F_Critical_Value" = critical_value_a,"P_Value" = p_value_a)

  test_stat_b <- anova_table["Factor B","MS"]/anova_table["Error","MS"]
  critical_value_b <- qf(1-alpha,anova_table["Factor B","df"],anova_table["Error","df"])
  p_value_b <- pf(test_stat_b,anova_table["Factor B","df"],anova_table["Error","df"],lower.tail = FALSE)
  F_test_df_b <- data.frame("F_Statistic" = test_stat_b,"F_Critical_Value" = critical_value_b,"P_Value" = p_value_b)
  
  F_test_df <- rbind(F_test_df_interact,F_test_df_a,F_test_df_b)
  rownames(F_test_df) <- c("Interaction","Factor A Effect","Factor B Effect")
  return(F_test_df)
}

F_tests <- F_Test_Effects(AnovaTable,0.05)

F_tests %>% 
   kable(caption = "F-Tests for Effects") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")

```


## Factor Mean Estimates
```{r echo=FALSE, message=FALSE, warning=FALSE}
factor_mean_CI <- function(AnovaTable,alpha,a,b,n,Yijbar,factor_a_level,factor_b_level){
  uhat = Yijbar[factor_a_level,factor_b_level]
se = sqrt(AnovaTable["Error","MS"]/n)
multiplier = qt(1-alpha/2,df=a*b*(n-1))
CI = c(uhat-multiplier*se,uhat+multiplier*se)
return(CI)
}


factor_mean_CIs_males <- 1:6 %>% map2(rep(1,6),~factor_mean_CI(AnovaTable,0.05,a,b,n,model_est_resid$Yijbar,.x,.y))

factor_mean_CIs_males <- do.call(rbind,factor_mean_CIs_males) %>% as.data.frame()
colnames(factor_mean_CIs_males) <- c("Lower Bound","Upper Bound")
rownames(factor_mean_CIs_males) <- 1:6 %>% map2(rep(1,6),~paste0("u",.x,.y))

 factor_mean_CIs_males[] <- lapply(factor_mean_CIs_males,function(y) y^2 )
# factor_mean_CIs_males[] <- lapply(factor_mean_CIs_males,function(y) sin(y/2)^2)
# factor_mean_CIs_males[] <- lapply(factor_mean_CIs_males,function(y) y * 100)

factor_mean_CIs_females <- 1:6 %>% map2(rep(2,6),~factor_mean_CI(AnovaTable,0.05,a,b,n,model_est_resid$Yijbar,.x,.y))

factor_mean_CIs_females <- do.call(rbind,factor_mean_CIs_females) %>% as.data.frame()
colnames(factor_mean_CIs_females) <- c("Lower Bound","Upper Bound")
rownames(factor_mean_CIs_females) <- 1:6 %>% map2(rep(2,6),~paste0("u",.x,.y))

factor_mean_CIs_females[] <- lapply(factor_mean_CIs_females,function(y) y^2 )
#factor_mean_CIs_females[] <- lapply(factor_mean_CIs_females,function(y) sin(y/2)^2)
#factor_mean_CIs_females[] <- lapply(factor_mean_CIs_females,function(y) y * 100)

output_lst_factor_mean_CI <- list(factor_mean_CIs_males,factor_mean_CIs_females)
output_lst_factor_mean_CI%>% 
   kable(caption = "Male and Female Factor Mean Confidence Intervals") %>% 
   kable_styling(bootstrap_options = "striped",full_width = TRUE,position = "center")


```




## Factor A and Factor B Family Pairwise Comparisons 
```{r echo=FALSE, message=FALSE, warning=FALSE}
both_factor_cis <- function(model_estimates_list,alpha.level,AnovaTable,a,b,n,method,g,parameter1_a,parameter2_a,parameter1_b,parameter2_b){
  
  estimates_a <- parameter1_a %>% map2(parameter2_a,~model_estimates_list$Alpha[.x] - model_estimates_list$Alpha[.y])
  se_a <- sqrt(2*AnovaTable["Error","MS"]/(b*n))
 
   
  estimates_b <- parameter1_b %>% map2(parameter2_b,~model_estimates_list$Beta[.x] - model_estimates_list$Beta[.y])
  se_b <- sqrt(2*AnovaTable["Error","MS"]/(a*n))
  
   
B <- qt(1-alpha.level/(2*g),a*b*(n-1))
Tukey_Bon_a = 1/sqrt(2)*qtukey(1-alpha.level/2,a,a*b*(n-1))
Tukey_Bon_b= 1/sqrt(2)*qtukey(1-alpha.level/2,b,a*b*(n-1))
Scheffe = sqrt((a+b-2)*qf(1-alpha.level,a+b-2,(n-1)*a*b))
Scheffe_Bon_a = sqrt((a-1)*qf(1-alpha.level/2,a-1,(n-1)*a*b))
Scheffe_Bon_b = sqrt((b-1)*qf(1-alpha.level/2,b-1,(n-1)*a*b))


compare_methods <- data.frame("Methods" = c("Bonferroni","Tukey-Bonferroni Factor A","Tukey-Bonferroni Factor B","Scheffe","Scheffe-Bonferroni FActor A","Scheffe-Bonferroni Factor B"),"Multipliers" = c(B,Tukey_Bon_a,Tukey_Bon_b,Scheffe,Scheffe_Bon_a,Scheffe_Bon_b))

 if(method == "Bonferroni"){
 multiplier_a <- B 
 multiplier_b <- B 
 }
 else if(method == "Tukey-Bonferroni"){
 multiplier_a <- Tukey_Bon_a 
 multiplier_b <- Tukey_Bon_b 
 }
 else if(method == "Scheffe"){
   multiplier_a <- Scheffe
   multiplier_b <- Scheffe
 }
else if(method == "Scheffe-Bonferroni"){
  multiplier_a <- Scheffe_Bon_a
  multiplier_b <- Scheffe_Bon_b
}
 else{
   return("Invalid Method")
 }

CI_s_a = estimates_a %>% map(~c(.x - multiplier_a*se_a, .x + multiplier_a*se_a))
CI_s_a <- do.call(rbind,CI_s_a) %>% as.data.frame()
print(CI_s_a)
colnames(CI_s_a) <- c("Lower Bound","Upper Bound")
rownames(CI_s_a) <- parameter1_a %>% map2_chr(parameter2_a,~paste0("u",.x,".","-","u",.y,".")) 


CI_s_b = estimates_b %>% map(~c(.x - multiplier_b*se_b, .x + multiplier_b*se_b))
CI_s_b <- do.call(rbind,CI_s_b) %>% as.data.frame()
colnames(CI_s_b) <- c("Lower Bound","Upper Bound")
rownames(CI_s_b) <- parameter1_b %>% map2_chr(parameter2_b,~paste0("u",".",.x,"-","u",".",.y)) 

output_lst <- list("Methods" = compare_methods,"CIs_a" = CI_s_a,"CIs_b" = CI_s_b)
return(output_lst)
}

both_cis <- both_factor_cis(model_est_resid,0.05,AnovaTable,a,b,n,"Bonferroni",16, 
                            c(1,1,1,1,1,2,2,2,2,3,3,3,4,4,5),c(2,3,4,5,6,3,4,5,6,4,5,6,5,6,6),c(1),c(2))


 both_cis$CIs_a %<>% select("Upper Bound","Lower Bound")
 colnames(both_cis$CIs_a) <- c("Lower Bound","Upper Bound")
 both_cis$CIs_a[] <- lapply(both_cis$CIs_a,function(y) y^2)
 temp <- both_cis$CIs_a["u3.-u4.","Upper Bound"]
 
 both_cis$CIs_a["u3.-u4.","Upper Bound"] <- both_cis$CIs_a["u3.-u4.","Lower Bound"] 
both_cis$CIs_a["u3.-u4.","Lower Bound"]  <- temp
 
 
 
 both_cis$CIs_b[] <- lapply(both_cis$CIs_b,function(y) y^2)

both_cis$Methods %>% 
   kable(caption = "Methods") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")

both_cis$CIs_a %>% 
   kable(caption = "Factor A: Age Group Pariwise Comparison Confidence Intervals") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")

both_cis$CIs_b %>% 
   kable(caption = "Factor B:  Sex Pairwise Comparison Confidence Intervals") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")

```













# Analysis of the Three Oldest Age Groups

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Inital Data Prep 
COVID19 = read.table("COVID19.txt", header = T, sep = "\t")
COVID19[652,c(5:7)] = 0
COVID19$AgeGroup %<>%  as.factor
COVID19$Sex %<>%  as.factor
COVID19$AgeGroup = factor(COVID19$AgeGroup,levels(COVID19$AgeGroup),1:7)
# 2 is female 1 is Male
COVID19$Sex = factor(COVID19$Sex,COVID19$Sex %>% levels,2:1) 
COVID19 %<>% filter( AgeGroup == 5 | AgeGroup == 6 | AgeGroup == 7)
COVID19$AgeGroup = factor(COVID19$AgeGroup,5:7,1:3)
COVID19$COVIDProp <- COVID19$COVIDProp %>% sqrt
#COVID19$COVIDProp <- 2*asin(sqrt(COVID19$COVIDProp)) 
```

## Model Estimates

```{r echo=FALSE, message=FALSE, warning=FALSE}
## Calculating Least Square Estimates

# Model Estimates and Residuals
model_estimates <- function(a,b,factorA,factorB,Y){

Yijbar = matrix(0,nrow = a,ncol = b)
for(i in 1:a)
{
  for(j in 1:b)
  {
    Yijbar[i,j] = mean(Y[factorA==i&factorB==j])
  }
}
u = mean(Y)
Yidotbar = apply(Yijbar,MARGIN = 1,mean)
Ydotjbar  = apply(Yijbar,MARGIN = 2,mean)
alpha = Yidotbar-u
beta = Ydotjbar-u
gamma = matrix(0,nrow = a,ncol = b)
for(i in 1:a)
{
  for(j in 1:b)
  {
    gamma[i,j] = Yijbar[i,j]-Yidotbar[i]-Ydotjbar[j]+u
  }
}

Yhat = rep(0,length(Y))
for(i in 1:a)
{
  for(j in 1:b)
  {
    Yhat[factorA==i&factorB==j] = Yijbar[i,j]
  }
}

e = Y-Yhat

return(list("Yijbar" = Yijbar,"Alpha" = alpha,"Beta" = beta,"Gamma" = gamma,"Yhat" = Yhat,"Residuals" = e,"Overall_Mean" = u))
}



Y = COVID19$COVIDProp
factorA = COVID19$AgeGroup
factorB = COVID19$Sex
a = factorA %>% levels %>% length 
b = factorB %>% levels %>% length 
n = 52

model_est_resid <- model_estimates(a,b,factorA,factorB,Y)

model_est_resid$Overall_Mean %>% 
   kable(caption = "Overall Mean") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")

model_est_resid$Alpha %>% 
   kable(caption = "Alpha Hat") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")

model_est_resid$Beta %>% 
   kable(caption = "Beta Hat") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")

model_est_resid$Gamma %>% 
   kable(caption = "Gamma Hat") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")
```

## Model Diagnostics

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Residual Plot
residual_plot <- ggplot()+
  geom_point(data = COVID19,aes(x = model_est_resid$Yhat, y = model_est_resid$Residuals ,shape = AgeGroup ,color = Sex ))+
  xlab("Fitted Values")+ylab("Residuals")+scale_color_manual(values = c("lightblue","pink"),labels = c("Male","Female"))+
  scale_shape_manual(values = c(18,19,20),labels = c("65-74 years","75-84 years","85 years and over"))


response_values <- c(rep(COVID19$Sex %>% levels %>% extract(1),3),rep(COVID19$Sex %>% levels %>% extract(2),3)) %>% 
         map2(rep(COVID19$AgeGroup %>% levels,2),~COVID19 %>%
         filter(Sex == .x,AgeGroup == .y) %>% extract2("COVIDProp")) 

factor_means <- c(rep(COVID19$Sex %>% levels %>% extract(1),3),rep(COVID19$Sex %>% levels %>% extract(2),3)) %>% 
         map2(rep(COVID19$AgeGroup %>% levels,2),~COVID19 %>%
         filter(Sex == .x,AgeGroup == .y) %>% extract2("COVIDProp") %>% mean) %>% unlist

fitted_values <- c(1:6) %>% map2(c(rep(52,6)),~rep(factor_means[.x],.y)) 

residuals <- response_values %>% map2(fitted_values,~.x - .y)


residual_plot <- residual_plot + map2(fitted_values,residuals,~geom_segment(
                                                           aes(x = .x %>% unique,y = .y %>% min,xend = .x %>% unique,
                                                               yend = .y %>% max),alpha = 0.25))
residual_plot

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# QQ Plot
e_standard <- model_est_resid$Residuals - (model_est_resid$Residuals %>% mean)
e_standard <- e_standard/model_est_resid$Residuals %>% sd

qq_plot <- ggplot(mapping = aes(sample = e_standard)) + geom_qq()+geom_qq_line(col = 2)+
  labs(title = "Normal Q-Q Plot")+xlab("Theoretical Quantiles")+
  ylab("Sample Quantiles")+theme_bw()+theme(panel.grid = element_blank())

qq_plot

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
# Interaction Plot
COVID19 %<>% group_by(AgeGroup,Sex)

interaction_plot <- ggplot(data =COVID19,aes(AgeGroup,COVIDProp,color = Sex,group = Sex)) +
  stat_summary(fun = mean,geom = "point")+
  stat_summary(fun = mean,geom = "line")+
  ylab("Mean Proportion of Deaths")+
  xlab("Factor A: Age Group" )+
  labs(color = "Factor B: Sex")+
  scale_x_discrete(labels = c("18-29 years","30-49 years","50-64 years","65-74 years","75-84 years","85 years and over"))+
  scale_color_manual(labels = c("Male","Female"),values = c("#7AD7F0","#FF69B4"))

interaction_plot

COVID19 %<>% ungroup
```

## Formal Analysis of Main Factor and Interaction Effects

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Anova Table Function
Anova.Table <- function(a,b,n,u,e,Yhat,alpha,beta,gamma,Y,factorA,factorB){
SSA = n*b*sum(alpha^2)
SSB = n*a*sum(beta^2)
SSAB = n*sum(gamma^2)

SSE = sum((Y-Yhat)^2)
SSTotal = sum((Y-u)^2)
AnovaTable = matrix(0,nrow = 5,ncol = 3)
AnovaTable[1,1] = SSA
AnovaTable[1,2] = a-1
AnovaTable[1,3] = SSA/(a-1)
AnovaTable[2,1] = SSB
AnovaTable[2,2] = b-1
AnovaTable[2,3] = SSB/(b-1)
AnovaTable[3,1] = SSAB
AnovaTable[3,2] = (a-1)*(b-1)
AnovaTable[3,3] = SSAB/((a-1)*(b-1))
AnovaTable[4,1] = SSE
AnovaTable[4,2] = a*b*(n-1)
AnovaTable[4,3] = SSE/(a*b*(n-1))
AnovaTable[5,1] = SSTotal
AnovaTable[5,2] = n*a*b-1
AnovaTable[5,3] = NA
AnovaTable = as.data.frame(AnovaTable)
rownames(AnovaTable) = c('Factor A','Factor B','AB Interaction','Error','Total')
colnames(AnovaTable) = c('SS','df','MS')
AnovaTable$SS %<>% as.numeric
AnovaTable$MS %<>% as.numeric
AnovaTable$df %<>% as.numeric
return(AnovaTable)
}

AnovaTable <- Anova.Table(a,b,n,model_est_resid$Overall_Mean,model_est_resid$Residuals,
                          model_est_resid$Yhat,model_est_resid$Alpha,model_est_resid$Beta,
                          model_est_resid$Gamma,Y,factorA,factorB)
AnovaTable %>% 
   kable(caption = "Anova Table") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
# F test for Interaction/Factor A/Factor B effects

F_Test_Effects <- function(anova_table,alpha){
  test_stat_interact <- anova_table["AB Interaction","MS"]/anova_table["Error","MS"]
  critical_value_interact <- qf(1-alpha,anova_table["AB Interaction","df"],anova_table["Error","df"])
  p_value_interact <- pf(test_stat_interact,anova_table["AB Interaction","df"],anova_table["Error","df"],lower.tail = FALSE)
  F_test_df_interact <- data.frame("F_Statistic" = test_stat_interact,"F_Critical_Value" = critical_value_interact,"P_Value" = p_value_interact)

  test_stat_a <- anova_table["Factor A","MS"]/anova_table["Error","MS"]
  critical_value_a <- qf(1-alpha,anova_table["Factor A","df"],anova_table["Error","df"])
  p_value_a <- pf(test_stat_a,anova_table["Factor A","df"],anova_table["Error","df"],lower.tail = FALSE)
  F_test_df_a <- data.frame("F_Statistic" = test_stat_a,"F_Critical_Value" = critical_value_a,"P_Value" = p_value_a)

  test_stat_b <- anova_table["Factor B","MS"]/anova_table["Error","MS"]
  critical_value_b <- qf(1-alpha,anova_table["Factor B","df"],anova_table["Error","df"])
  p_value_b <- pf(test_stat_b,anova_table["Factor B","df"],anova_table["Error","df"],lower.tail = FALSE)
  F_test_df_b <- data.frame("F_Statistic" = test_stat_b,"F_Critical_Value" = critical_value_b,"P_Value" = p_value_b)
  
  F_test_df <- rbind(F_test_df_interact,F_test_df_a,F_test_df_b)
  rownames(F_test_df) <- c("Interaction","Factor A Effect","Factor B Effect")
  return(F_test_df)
}

F_tests <- F_Test_Effects(AnovaTable,0.05)

F_tests %>% 
   kable(caption = "F-Tests for Effects") %>% 
   kable_styling(bootstrap_options = "striped",full_width = FALSE,position = "center")

```


## Conclusion














